# ============================================
# NOM DU WORKFLOW (affichÃ© dans GitHub UI)
# ============================================
name: CI - Lint, Build & Test

# ============================================
# TRIGGERS : Quand le workflow se dÃ©clenche
# ============================================
on:
  # Ã€ chaque push sur develop ou main
  push:
    branches: 
      - develop
  
  # Ã€ chaque Pull Request vers develop ou main
  pull_request:
    branches:
      - develop

# ============================================
# JOBS : TÃ¢ches Ã  exÃ©cuter (en parallÃ¨le)
# ============================================
jobs:
  # ==========================================
  # JOB 1 : BACKEND (NestJS + Prisma)
  # ==========================================
  backend-ci:
    name: ğŸ”§ Backend - NestJS + Prisma
    runs-on: ubuntu-latest
    
    # Toutes les commandes s'exÃ©cutent dans ./backend
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      # ===== STEP 1 : RÃ©cupÃ©rer le code =====
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        # Clone ton repo dans la VM
        # Sans Ã§a, la VM est vide !
      
      # ===== STEP 2 : Installer Node.js =====
      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
        # Installe Node.js v22
        # Active le cache npm pour aller plus vite
        # 1Ã¨re fois : 2 min | Ensuite : 30s
      
      # ===== STEP 3 : Installer les dÃ©pendances =====
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        # npm ci = npm install MAIS :
        # - Plus rapide
        # - Plus fiable (respect package-lock.json)
        # - Ne modifie jamais package-lock.json
        # TOUJOURS utiliser npm ci en CI/CD !
      
      # ===== STEP 4 : GÃ©nÃ©rer Prisma Client =====
      - name: ğŸ”§ Generate Prisma Client
        run: npx prisma generate
        # GÃ©nÃ¨re les types TypeScript depuis schema.prisma
        # OBLIGATOIRE sinon erreurs TypeScript
        # Ã‰quivalent Ã  ce que tu fais en local
      
      # ===== STEP 5 : VÃ©rifier OpenAPI Spec =====
      - name: ğŸ“‹ Validate OpenAPI Spec
        run: |
          if [ -f "api-spec.yml" ]; then
            echo "âœ… api-spec.yml found"
          else
            echo "âŒ api-spec.yml missing!"
            exit 1
          fi
        # VÃ©rifie que le fichier OpenAPI existe
        # Si absent â†’ Ã‰chec du workflow
      
      # ===== STEP 6 : Linter (QualitÃ© du code) =====
      - name: ğŸ” Lint code with ESLint
        run: npm run lint
        # VÃ©rifie :
        # - Syntaxe correcte
        # - Respect des rÃ¨gles ESLint
        # - Pas de variables inutilisÃ©es
        # - Etc.
        # Si erreur â†’ Workflow Ã©choue âŒ
      
      # ===== STEP 7 : Build TypeScript =====
      - name: ğŸ—ï¸ Build TypeScript project
        run: npm run build
        # Compile TypeScript â†’ JavaScript
        # VÃ©rifie :
        # - Pas d'erreurs de typage
        # - Imports corrects
        # - Code compilable
        # GÃ©nÃ¨re ./dist/
      
      # ===== STEP 8 : Tests (si configurÃ©s) =====
      - name: ğŸ§ª Run unit tests
        run: npm test || echo "âš ï¸ No tests configured yet"
        continue-on-error: true
        # || = Si npm test Ã©choue, affiche message sans bloquer
        # continue-on-error = N'Ã©choue pas le job si Ã§a crash
        # Ã€ enlever quand tu auras des tests !
      
      # ===== STEP 9 : VÃ©rifier Schema Prisma =====
      - name: ğŸ—„ï¸ Validate Prisma Schema
        run: npx prisma validate
        # VÃ©rifie que schema.prisma est valide
        # Relations correctes, types OK, etc.
      
      # ===== STEP 10 : Check Migrations =====
      - name: ğŸ“Š Check Prisma Migrations
        run: |
          if [ -d "prisma/migrations" ]; then
            echo "âœ… Migrations folder exists"
            ls -la prisma/migrations/
          else
            echo "âš ï¸ No migrations yet"
          fi
        # Liste les migrations existantes
        # Informatif, n'Ã©choue pas

  # ==========================================
  # JOB 2 : FRONTEND (React + Vite)
  # ==========================================
  frontend-ci:
    name: âš›ï¸ Frontend - React + Vite
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      # ===== STEP 1 : RÃ©cupÃ©rer le code =====
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # ===== STEP 2 : Installer Node.js =====
      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # ===== STEP 3 : Installer les dÃ©pendances =====
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # ===== STEP 4 : Linter =====
      - name: ğŸ” Lint code with ESLint
        run: npm run lint
        continue-on-error: true
        # continue-on-error car lint peut ne pas Ãªtre configurÃ©
        # Ã€ enlever quand c'est configurÃ© !
      
      # ===== STEP 5 : Build Vite =====
      - name: ğŸ—ï¸ Build Vite project
        run: npm run build
        env:
          # Variable d'env pour le build
          VITE_API_URL: http://localhost:3001/api/v1
        # Build avec Vite
        # GÃ©nÃ¨re ./dist/
        # VITE_API_URL nÃ©cessaire pour que le build passe
        # En prod, cette valeur sera diffÃ©rente (Railway)
      
      # ===== STEP 6 : VÃ©rifier le build =====
      - name: ğŸ“¦ Check build output
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build successful!"
            ls -lh dist/
          else
            echo "âŒ Build folder not found!"
            exit 1
          fi
        # VÃ©rifie que ./dist/ existe bien
        # Liste les fichiers gÃ©nÃ©rÃ©s
      
      # ===== STEP 7 : Tests (si configurÃ©s) =====
      - name: ğŸ§ª Run tests
        run: npm test || echo "âš ï¸ No tests configured yet"
        continue-on-error: true

  # ==========================================
  # JOB 3 : QUALITÃ‰ GLOBALE (Optionnel)
  # ==========================================
  code-quality:
    name: ğŸ“Š Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # ===== VÃ©rifier structure projet =====
      - name: ğŸ—‚ï¸ Verify project structure
        run: |
          echo "Checking project structure..."
          
          # VÃ©rifier fichiers essentiels backend
          [ -f "backend/package.json" ] && echo "âœ… backend/package.json" || echo "âŒ Missing backend/package.json"
          [ -f "backend/prisma/schema.prisma" ] && echo "âœ… schema.prisma" || echo "âŒ Missing schema.prisma"
          [ -f "backend/api-spec.yml" ] && echo "âœ… api-spec.yml" || echo "âŒ Missing api-spec.yml"
          
          # VÃ©rifier fichiers essentiels frontend
          [ -f "frontend/package.json" ] && echo "âœ… frontend/package.json" || echo "âŒ Missing frontend/package.json"
          [ -f "frontend/vite.config.ts" ] && echo "âœ… vite.config.ts" || echo "âŒ Missing vite.config.ts"
          
          # VÃ©rifier Docker
          [ -f "docker-compose.yml" ] && echo "âœ… docker-compose.yml" || echo "âŒ Missing docker-compose.yml"
          
          echo "Project structure validation complete!"
      
      # ===== Compter lignes de code =====
      - name: ğŸ“ˆ Count lines of code
        run: |
          echo "=== Lines of Code ==="
          echo "Backend TypeScript:"
          find backend/src -name "*.ts" | xargs wc -l | tail -1
          echo ""
          echo "Frontend TypeScript/TSX:"
          find frontend/src -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1
        continue-on-error: true